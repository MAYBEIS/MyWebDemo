generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model comments {
  id             String     @id
  content        String
  postId         String
  authorId       String
  parentId       String?
  likes          Int        @default(0)  // 点赞数
  isRecalled     Boolean    @default(false)  // 是否撤回
  recalledAt     DateTime?  // 撤回时间
  createdAt      DateTime   @default(now())
  updatedAt      DateTime
  comments       comments?  @relation("commentsTocomments", fields: [parentId], references: [id], onDelete: Cascade)
  other_comments comments[] @relation("commentsTocomments")
  users          users      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  posts          posts      @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment_likes  comment_likes[]

  @@index([authorId])
  @@index([postId])
  @@index([isRecalled])
}

// 用户对评论的点赞记录
model comment_likes {
  id        String   @id
  commentId String
  userId    String
  createdAt DateTime @default(now())
  comments  comments @relation(fields: [commentId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])  // 同一用户只能点赞一次
  @@index([commentId])
  @@index([userId])
}

model guestbooks {
  id        String   @id
  message   String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime
  users     users    @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

model post_tags {
  id     String @id
  postId String
  tag    String
  posts  posts  @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, tag])
  @@index([tag])
}

model posts {
  id             String          @id
  slug           String          @unique
  title          String
  content        String
  excerpt        String?
  category       String?
  coverImage     String?
  published      Boolean         @default(false)
  views          Int             @default(0)
  likes          Int             @default(0)
  authorId       String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  comments       comments[]
  post_tags      post_tags[]
  users          users           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post_likes     post_likes[]
  post_bookmarks post_bookmarks[]

  @@index([createdAt])
  @@index([published])
  @@index([category])
}

model sessions {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model users {
  id              String            @id
  email           String            @unique
  name            String
  password        String
  isAdmin         Boolean           @default(false)
  isBanned        Boolean           @default(false)  // 是否被封禁
  bannedReason    String?           // 封禁原因
  bannedAt        DateTime?         // 封禁时间
  avatar          String?
  bio             String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  comments        comments[]
  guestbooks      guestbooks[]
  posts           posts[]
  post_likes      post_likes[]
  post_bookmarks  post_bookmarks[]
  comment_likes   comment_likes[]
  orders          orders[]
  product_keys    product_keys[]
  user_memberships user_memberships?
  user_coupons    user_coupons[]

  @@index([isBanned])
}

// 用户对文章的点赞记录
model post_likes {
  id        String   @id
  postId    String
  userId    String
  createdAt DateTime @default(now())
  posts     posts    @relation(fields: [postId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])  // 同一用户只能点赞一次
  @@index([postId])
  @@index([userId])
}

// 用户对文章的收藏记录
model post_bookmarks {
  id        String   @id
  postId    String
  userId    String
  createdAt DateTime @default(now())
  posts     posts    @relation(fields: [postId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])  // 同一用户只能收藏一次
  @@index([postId])
  @@index([userId])
}

// 系统设置
model system_settings {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 商店产品
model products {
  id          String   @id
  name        String
  description String
  price       Float    // 价格
  type        String   // 产品类型: membership, serial_key, digital
  duration    Int?     // 会员时长(天)，仅会员产品有效
  features    String?  // 产品特性 JSON 字符串
  image       String?  // 产品图片
  stock       Int      @default(-1)  // 库存，-1表示无限
  status      Boolean  @default(true) // 是否上架
  sortOrder   Int      @default(0)   // 排序
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      orders[]
  product_keys product_keys[]

  @@index([type])
  @@index([status])
}

// 产品密钥（序列号/激活码）
model product_keys {
  id        String   @id
  productId String
  key       String   @unique  // 序列号/激活码
  status    String   @default("available") // available, sold, used, expired
  orderId   String?  @unique
  userId    String?
  expiresAt DateTime?  // 过期时间
  createdAt DateTime @default(now())
  usedAt    DateTime?
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)
  orders    orders?  @relation(fields: [orderId], references: [id])
  users     users?   @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([status])
  @@index([key])
}

// 订单
model orders {
  id           String   @id
  orderNo      String   @unique  // 订单号
  userId       String
  productId    String
  productKey   String?  // 分配的产品密钥
  amount       Float    // 订单金额
  status       String   @default("pending") // pending, paid, completed, cancelled, refunded
  paymentMethod String? // 支付方式
  paymentTime  DateTime? // 支付时间
  remark       String?  // 备注
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  products     products @relation(fields: [productId], references: [id], onDelete: Cascade)
  product_keys product_keys?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// 用户会员
model user_memberships {
  id        String   @id
  userId    String   @unique
  type      String   // 会员类型: monthly, yearly, lifetime
  startDate DateTime
  endDate   DateTime
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([active])
  @@index([endDate])
}

// 支付渠道
model payment_channels {
  id          String   @id
  code        String   @unique  // 渠道代码: wechat, alipay
  name        String            // 渠道名称
  description String?           // 渠道描述
  enabled     Boolean  @default(false)  // 是否启用
  config      String            // 配置JSON字符串
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([enabled])
}

// 优惠券
model coupons {
  id          String   @id
  code        String   @unique  // 优惠券代码
  name        String            // 优惠券名称
  type        String            // 类型: percentage(百分比), fixed(固定金额)
  value       Float             // 折扣值(百分比或固定金额)
  minAmount   Float    @default(0)  // 最低订单金额
  maxDiscount Float?             // 最大折扣金额(百分比折扣时有效)
  totalCount  Int      @default(-1)  // 总数量(-1表示无限)
  usedCount   Int      @default(0)   // 已使用数量
  startTime   DateTime           // 生效开始时间
  endTime     DateTime           // 生效结束时间
  status      Boolean  @default(true) // 是否启用
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user_coupons user_coupons[]

  @@index([code])
  @@index([status])
}

// 用户优惠券
model user_coupons {
  id        String   @id
  userId    String
  couponId  String
  orderId   String?  // 使用该优惠券的订单ID
  status    String   @default("unused") // unused, used, expired
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  coupons   coupons  @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([userId, couponId])
  @@index([userId])
  @@index([status])
}
