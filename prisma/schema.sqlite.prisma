// SQLite Schema - 用于开发环境
// 使用方式：DATABASE_URL="file:./dev.db" npx prisma db push --schema=prisma/schema.sqlite.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model comments {
  id             String     @id
  content        String
  postId         String
  authorId       String
  parentId       String?
  likes          Int        @default(0)
  isRecalled     Boolean    @default(false)
  recalledAt     DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime
  comments       comments?  @relation("commentsTocomments", fields: [parentId], references: [id], onDelete: Cascade)
  other_comments comments[] @relation("commentsTocomments")
  users          users      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  posts          posts      @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment_likes  comment_likes[]

  @@index([authorId])
  @@index([postId])
  @@index([isRecalled])
}

model comment_likes {
  id        String   @id
  commentId String
  userId    String
  createdAt DateTime @default(now())
  comments  comments @relation(fields: [commentId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model guestbooks {
  id        String   @id
  message   String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime
  users     users    @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

model post_tags {
  id     String @id
  postId String
  tag    String
  posts  posts  @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, tag])
  @@index([tag])
}

model posts {
  id             String          @id
  slug           String          @unique
  title          String
  content        String
  excerpt        String?
  category       String?
  coverImage     String?
  published      Boolean         @default(false)
  views          Int             @default(0)
  likes          Int             @default(0)
  authorId       String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  comments       comments[]
  post_tags      post_tags[]
  users          users           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post_likes     post_likes[]
  post_bookmarks post_bookmarks[]

  @@index([createdAt])
  @@index([published])
  @@index([category])
}

model sessions {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model users {
  id              String            @id
  email           String            @unique
  name            String
  password        String
  isAdmin         Boolean           @default(false)
  isBanned        Boolean           @default(false)
  bannedReason    String?
  bannedAt        DateTime?
  avatar          String?
  bio             String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  comments        comments[]
  guestbooks      guestbooks[]
  posts           posts[]
  post_likes      post_likes[]
  post_bookmarks  post_bookmarks[]
  comment_likes   comment_likes[]
  orders          orders[]
  product_keys    product_keys[]
  user_memberships user_memberships?
  user_coupons    user_coupons[]

  @@index([isBanned])
}

model post_likes {
  id        String   @id
  postId    String
  userId    String
  createdAt DateTime @default(now())
  posts     posts    @relation(fields: [postId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model post_bookmarks {
  id        String   @id
  postId    String
  userId    String
  createdAt DateTime @default(now())
  posts     posts    @relation(fields: [postId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model system_settings {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model products {
  id          String   @id
  name        String
  description String
  price       Float
  type        String
  duration    Int?
  features    String?
  image       String?
  stock       Int      @default(-1)
  status      Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      orders[]
  product_keys product_keys[]

  @@index([type])
  @@index([status])
}

model product_keys {
  id        String   @id
  productId String
  key       String   @unique
  status    String   @default("available")
  orderId   String?  @unique
  userId    String?
  expiresAt DateTime?
  createdAt DateTime @default(now())
  usedAt    DateTime?
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)
  orders    orders?  @relation(fields: [orderId], references: [id])
  users     users?   @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([status])
  @@index([key])
}

model orders {
  id           String   @id
  orderNo      String   @unique
  userId       String
  productId    String
  productKey   String?
  amount       Float
  status       String   @default("pending")
  paymentMethod String?
  paymentTime  DateTime?
  remark       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  products     products @relation(fields: [productId], references: [id], onDelete: Cascade)
  product_keys product_keys?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model user_memberships {
  id        String   @id
  userId    String   @unique
  type      String
  startDate DateTime
  endDate   DateTime
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([active])
  @@index([endDate])
}

model payment_channels {
  id          String   @id
  code        String   @unique
  name        String
  description String?
  enabled     Boolean  @default(false)
  config      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([enabled])
}

model coupons {
  id          String   @id
  code        String   @unique
  name        String
  type        String
  value       Float
  minAmount   Float    @default(0)
  maxDiscount Float?
  totalCount  Int      @default(-1)
  usedCount   Int      @default(0)
  startTime   DateTime
  endTime     DateTime
  status      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user_coupons user_coupons[]

  @@index([code])
  @@index([status])
}

model user_coupons {
  id        String   @id
  userId    String
  couponId  String
  orderId   String?
  status    String   @default("unused")
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  coupons   coupons  @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([userId, couponId])
  @@index([userId])
  @@index([status])
}